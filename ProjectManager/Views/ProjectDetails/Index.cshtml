@using ProjectManager.Models
@model IEnumerable<ProjectManager.Models.Department>
@{
    ViewBag.Title = "專案成員邀請";
}

@section style{
    <style>
        #sel1 {
            width: 200px;
            margin: 15px;
        }

        #emplist {
            margin: 5px;
        }

        img {
            width: 30px;
        }

        p, .ckbox1 {
            display: inline;
            margin: 15px;
        }

        #scrollDiv {
            height: 700px;
        }

        .alert alert-primary {
            margin: 5px;
        }

        .smallDiv {
            width: 20px;
            background-color: crimson;
        }

        .flip {
            text-align: center;
            background: #fbec06;
            cursor: pointer;
            font-family: 'Arial';
        }

        .rounded-circle {
            margin: 2px;
        }
    </style>
}

<div class="container">
    <div class="row">
        <div class="col-sm">
            <label>選擇部門</label>
            <select id="sel1">
                <option>所有部門</option>
                @foreach (var _dep in Model)
                {
                    <option value="@_dep.DepartmentGUID">@_dep.DepartmentName</option>
                }
            </select>
            <div id="teamcount" style="float:right">
                <div class="flip"><i class="fas fa-users"></i>目前團隊成員</div>
                <div class="panel" id="teamPanel">
                    @foreach (var _ProjectMemeber in (List<ProjectMembers>)ViewBag.ThisProjectMember)
                    {
                        <img src="~/image/avatar.png" title="@_ProjectMemeber.Employee.EmployeeName" class="rounded-circle" data-guid="@_ProjectMemeber.EmployeeGUID" />
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm">
            <div id="scrollDiv">
                <!--runin-->
                @foreach (var _emp in (List<Employee>)ViewBag.FirstEmpList)
                {
                    <div class="alert alert-primary" role="alert" id="empDiv">
                        <img src="~/image/avatar.png" class="rounded-circle" />
                        <p>@_emp.EmployeeName</p>
                        <input type="checkbox" class="ckbox1" style="float:right" value="@_emp.EmployeeGUID" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">     
                <a class="btn btn-danger" href="@Url.Action("AssignTask","ProjectDetails")">點我查看成員目前承接工作</a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="no">取消</button>
                <button type="button" class="btn btn-primary" id="yes">確定移出團隊</button>
            </div>
        </div>
    </div>
</div>

@section script{
<script>
    $(document).ready(function ()
    {
        var selecter = $("#sel1");
        var flag = false;
        selecter.change(function () //選擇部門事件
        {
                var selectedopt = $(this).find(":selected").val();
                $.getJSON('@Url.Action("selectdep", "ProjectDetails")', { "depid": selectedopt }, function (datas)
                {
                    var sel = $('#scrollDiv');
                    var docFrag = $(document.createDocumentFragment());
                    sel.html($("<img></img>").attr("src", "/image/loading.gif"));
                    $.each(datas, function (idx, _emp)
                    {
                        var p = $("<p></p>").text(_emp.EmployeeName);// Find assigned
                        var input = $("<input/>").attr("type", "checkbox").attr("class", "ckbox1").attr("style", "float:right").val(_emp.EmployeeGUID);
                        var img = $("<img/>").attr("src", "/image/avatar.png").attr("class", "rounded-circle");
                        var empdiv = $("<div></div>").attr("class", "alert alert-primary");
                        empdiv.append([img, p, input]);
                        docFrag.append(empdiv);
                    })
                    sel.html(docFrag);
                    if (!flag) { selecter.children().first().remove()};
                    flag = true;
                    SendIDToTeamTable();
            })
        })

        SendIDToTeamTable();
        function SendIDToTeamTable()//勾選成員、取消勾選事件
        {
            $('.ckbox1').on('change', function ()
            {
                var memberGUID = $(this).val();
                var memberName = $(this).prev().text();
                var chkboxcheck = $(this);
                if (this.checked)
                {
                    $(".panel").html($("<img></img>").attr("src", "/image/loading.gif"))
                    $.ajax({
                        url: '@Url.Action("AddProjectMember", "ProjectDetails")',
                        data: { "memberID": memberGUID},
                        success: function ()
                        {
                            ReloadTeamCount();
                        }
                        , error: function () { alert(memberName + " 已存在於此專案"); chkboxcheck.prop('checked', false); ReloadTeamCount();}
                    });
                }
                else
                {
                    $(".panel").html($("<img></img>").attr("src", "/image/loading.gif"))
                    $.ajax({
                        url: '@Url.Action("DeleteProjectMember", "ProjectDetails")',
                        data: { "memberID": memberGUID},
                        success: function ()
                        {
                            ReloadTeamCount();
                        }
                    });
                }
            });
        }

        function ReloadTeamCount()//重新載入專案成員(當勾選成員時觸發)
        {
            $.getJSON('@Url.Action("ReloadTeamCount", "ProjectDetails")', { "projectID": $("#PJGUID").text() }, function (datas)
            {
                var docFrag = $(document.createDocumentFragment());
                var panel = $(".panel");
                $.each(datas, function (idx, _emp)
                {
                    var empImg = $("<img/>").attr("src", "/image/avatar.png").attr("class", "rounded-circle").attr("title", _emp.Employee.EmployeeName)
                        .attr("data-guid", _emp.EmployeeGUID).tooltip();
                    docFrag.append(empImg);
                })
                panel.html(docFrag);
            })
        }

        $(function () // 目前專案成員滑塊
        {
            $(".flip").click(function () {
                $(".panel").slideToggle("slow");
            });
        });

        $("#teamPanel").on("mouseenter", "img", function (){
            $(this).attr("src", "/image/CancelIcon.png").attr("class", "rounded-circle").attr("style", "opacity:0.4");
        })
        $("#teamPanel").on("mouseleave", "img", function () {
            $(this).attr("src", "/image/avatar.png").attr("class", "rounded-circle").attr("style", "opacity:1");
        })

        $("#teamPanel").on("click", "img", function () { //直接由專案成員方塊刪除
            var circleimg = $(this);
            var EmpName = circleimg.attr("data-original-title");
            var memberGUID = circleimg.data("guid");
             $.ajax({
                    url: '@Url.Action("TaskExist", "ProjectDetails")',
                    data: { "memberGUID": memberGUID },
                 success: function (data)
                 {
                     if (data != "NoTask") {
                         $('#myModal').modal('show');
                         $("#myModalLabel").text(EmpName + " 目前有被分配到工作!要移出團隊嗎?");
                     }
                     else
                     {
                         RemoveMember();
                     }
                 }
        })

            $("#yes").click(function ()
            {
                RemoveMember();
                $('#myModal').modal('hide');
            })

            function RemoveMember()
            {
                  $.ajax({
                             url: '@Url.Action("DeleteProjectMember", "ProjectDetails")',
                             data: { "memberID": memberGUID },
                              success: function (){
                               circleimg.remove();
                            }
                });
                if ($("#scrollDiv input").val() == memberGUID)
                {
                    $("#scrollDiv input").prop('checked', false);
                }
            }
        })
        $(".rounded-circle").tooltip();
    })
</script>
}

@section nav{
    @Html.Partial("_PartialPageNav", "Shared")
}
